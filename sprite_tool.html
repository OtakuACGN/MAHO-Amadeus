<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精灵图裁剪与预览工具</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { display: flex; gap: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 1200px; width: 100%; }
        .control-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; min-width: 300px; }
        .preview-panel { flex: 2; display: flex; flex-direction: column; align-items: center; gap: 20px; overflow: auto; }
        
        .group { border: 1px solid #eee; padding: 15px; border-radius: 6px; }
        .group h3 { margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #333; }
        
        label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 14px; }
        input[type="number"] { width: 80px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
        input[type="file"] { width: 100%; }
        
        button { padding: 8px 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        button.secondary { background-color: #6c757d; }
        button.secondary:hover { background-color: #545b62; }
        
        .canvas-container { position: relative; border: 1px solid #ccc; background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABp0RVh0U29mdHdhcmUAUGFpbnQuTkVUIHYzLjUuMTAw9HKhAAAAFElEQVQ4T2NjgMj/o2E4GgYjDQAA1qa8h/y7FjAAAAAASUVORK5CYII='); }
        canvas { display: block; }
        
        #cropOverlay { position: absolute; top: 0; left: 0; pointer-events: none; }
        
        .info { margin-top: 10px; font-size: 12px; color: #666; }
    </style>
</head>
<body>

    <h1>精灵图裁剪与预览工具</h1>

    <div class="container">
        <div class="control-panel">
            <div class="group">
                <h3>1. 上传图片</h3>
                <input type="file" id="fileInput" accept="image/*">
            </div>

            <div class="group">
                <h3>2. 裁剪设置 (像素)</h3>
                <div class="info">使用方向键微调，Shift+方向键快调</div>
                <label>上边距 (Top): <input type="number" id="cropTop" value="0" min="0"></label>
                <label>下边距 (Bottom): <input type="number" id="cropBottom" value="0" min="0"></label>
                <label>左边距 (Left): <input type="number" id="cropLeft" value="0" min="0"></label>
                <label>右边距 (Right): <input type="number" id="cropRight" value="0" min="0"></label>
                <button class="secondary" id="resetCropBtn">重置裁剪</button>
            </div>

            <div class="group">
                <h3>3. 动画设置</h3>
                <label>行数 (Rows): <input type="number" id="rows" value="1" min="1"></label>
                <label>列数 (Cols): <input type="number" id="cols" value="1" min="1"></label>
                <label>帧率 (FPS): <input type="number" id="fps" value="12" min="1"></label>
                <label>总帧数: <input type="number" id="totalFrames" value="" placeholder="默认 行*列"></label>
            </div>

            <div class="group">
                <h3>4. 预览控制</h3>
                <div style="display: flex; gap: 10px;">
                    <button id="playBtn">播放</button>
                    <button id="stopBtn" class="secondary">暂停</button>
                </div>
                <div class="info" id="animInfo">帧: 0 / 0</div>
            </div>
        </div>

        <div class="preview-panel">
            <div class="group">
                <h3>裁剪预览 (原始图)</h3>
                <div class="canvas-container">
                    <canvas id="sourceCanvas"></canvas>
                    <canvas id="cropOverlay"></canvas>
                </div>
                <div class="info" id="sourceInfo">尺寸: 0 x 0</div>
            </div>

            <div class="group">
                <h3>动画预览</h3>
                <div class="canvas-container">
                    <canvas id="previewCanvas"></canvas>
                </div>
                <div class="info" id="previewInfo">单帧尺寸: 0 x 0</div>
                <button id="exportCropBtn" style="margin-top:10px;">导出裁剪图片</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const inputs = {
            top: document.getElementById('cropTop'),
            bottom: document.getElementById('cropBottom'),
            left: document.getElementById('cropLeft'),
            right: document.getElementById('cropRight'),
            rows: document.getElementById('rows'),
            cols: document.getElementById('cols'),
            fps: document.getElementById('fps'),
            totalFrames: document.getElementById('totalFrames')
        };
        const sourceCanvas = document.getElementById('sourceCanvas');
        const cropOverlay = document.getElementById('cropOverlay');
        const previewCanvas = document.getElementById('previewCanvas');
        const sourceCtx = sourceCanvas.getContext('2d');
        const overlayCtx = cropOverlay.getContext('2d');
        const previewCtx = previewCanvas.getContext('2d');
        
        // State
        let originalImage = null;
        let isPlaying = false;
        let currentFrame = 0;
        let animationId = null;
        let lastFrameTime = 0;

        // Init
        function init() {
            addEventListeners();
        }

        function addEventListeners() {
            fileInput.addEventListener('change', handleFileSelect);
            
            // Inputs change
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', update);
            });

            document.getElementById('resetCropBtn').addEventListener('click', () => {
                inputs.top.value = 0;
                inputs.bottom.value = 0;
                inputs.left.value = 0;
                inputs.right.value = 0;
                update();
            });

            document.getElementById('playBtn').addEventListener('click', play);
            document.getElementById('stopBtn').addEventListener('click', stop);

            // Keyboard shortcuts for cropping
            window.addEventListener('keydown', (e) => {
                if (!originalImage) return;
                const step = e.shiftKey ? 10 : 1;
                // Only if not typing in an input (unless it's one of the crop inputs)
                if (e.target.tagName === 'INPUT' && !e.target.id.startsWith('crop')) return;

                let changed = false;
                switch(e.key) {
                    case 'ArrowUp': 
                        inputs.bottom.value = Math.max(0, parseInt(inputs.bottom.value) + step); 
                        changed = true; 
                        break;
                    case 'ArrowDown': 
                        inputs.top.value = Math.max(0, parseInt(inputs.top.value) + step); 
                        changed = true; 
                        break;
                    case 'ArrowLeft': 
                        inputs.right.value = Math.max(0, parseInt(inputs.right.value) + step); 
                        changed = true; 
                        break;
                    case 'ArrowRight': 
                        inputs.left.value = Math.max(0, parseInt(inputs.left.value) + step); 
                        changed = true; 
                        break;
                }
                if (changed) {
                    e.preventDefault();
                    update();
                }
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                originalImage = new Image();
                originalImage.onload = () => {
                    // Reset crop
                    inputs.top.value = 0;
                    inputs.bottom.value = 0;
                    inputs.left.value = 0;
                    inputs.right.value = 0;
                    
                    // Resize canvases
                    sourceCanvas.width = originalImage.width;
                    sourceCanvas.height = originalImage.height;
                    cropOverlay.width = originalImage.width;
                    cropOverlay.height = originalImage.height;
                    
                    document.getElementById('sourceInfo').textContent = `尺寸: ${originalImage.width} x ${originalImage.height}`;
                    
                    sourceCtx.drawImage(originalImage, 0, 0);
                    update();
                };
                originalImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function update() {
            if (!originalImage) return;
            drawOverlay();
            updatePreviewStatic();
        }

        function getCropRect() {
            const top = parseInt(inputs.top.value) || 0;
            const bottom = parseInt(inputs.bottom.value) || 0;
            const left = parseInt(inputs.left.value) || 0;
            const right = parseInt(inputs.right.value) || 0;

            const width = Math.max(1, originalImage.width - left - right);
            const height = Math.max(1, originalImage.height - top - bottom);
            
            return { x: left, y: top, w: width, h: height };
        }

        function drawOverlay() {
            overlayCtx.clearRect(0, 0, cropOverlay.width, cropOverlay.height);
            
            const { x, y, w, h } = getCropRect();

            // Darken everything
            overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            overlayCtx.fillRect(0, 0, cropOverlay.width, cropOverlay.height);

            // Clear the crop area (make it visible)
            overlayCtx.clearRect(x, y, w, h);
            
            // Draw border around crop area
            overlayCtx.strokeStyle = '#00ff00';
            overlayCtx.lineWidth = 2;
            overlayCtx.strokeRect(x, y, w, h);
        }

        function getFrameData() {
            const { w: cropW, h: cropH } = getCropRect();
            const rows = parseInt(inputs.rows.value) || 1;
            const cols = parseInt(inputs.cols.value) || 1;
            
            const frameW = Math.floor(cropW / cols);
            const frameH = Math.floor(cropH / rows);
            
            return { frameW, frameH, rows, cols };
        }

        function updatePreviewStatic() {
            if (isPlaying) return; // Don't interfere if playing
            
            const { frameW, frameH } = getFrameData();
            previewCanvas.width = frameW;
            previewCanvas.height = frameH;
            
            document.getElementById('previewInfo').textContent = `单帧尺寸: ${frameW} x ${frameH}`;
            
            // Draw first frame
            drawFrame(0);
        }

        // 导出裁剪图片
        document.getElementById('exportCropBtn').onclick = function() {
            if (!originalImage) return;
            const cropRect = getCropRect();
            // 创建一个临时canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = cropRect.w;
            tempCanvas.height = cropRect.h;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(originalImage, cropRect.x, cropRect.y, cropRect.w, cropRect.h, 0, 0, cropRect.w, cropRect.h);
            tempCanvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sprite_crop.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 'image/png');
        }

        function drawFrame(frameIndex) {
            const { x: cropX, y: cropY } = getCropRect();
            const { frameW, frameH, cols } = getFrameData();
            
            const colIndex = frameIndex % cols;
            const rowIndex = Math.floor(frameIndex / cols);
            
            const srcX = cropX + colIndex * frameW;
            const srcY = cropY + rowIndex * frameH;
            
            previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
            previewCtx.drawImage(originalImage, srcX, srcY, frameW, frameH, 0, 0, frameW, frameH);
            
            // Update info
            const rows = parseInt(inputs.rows.value) || 1;
            const total = inputs.totalFrames.value ? parseInt(inputs.totalFrames.value) : (rows * cols);
            document.getElementById('animInfo').textContent = `帧: ${frameIndex + 1} / ${total}`;
        }

        function play() {
            if (!originalImage) return;
            if (isPlaying) return;
            
            isPlaying = true;
            lastFrameTime = performance.now();
            
            const loop = (time) => {
                if (!isPlaying) return;
                
                const fps = parseInt(inputs.fps.value) || 12;
                const interval = 1000 / fps;
                
                if (time - lastFrameTime > interval) {
                    const { rows, cols } = getFrameData();
                    const total = inputs.totalFrames.value ? parseInt(inputs.totalFrames.value) : (rows * cols);
                    
                    currentFrame = (currentFrame + 1) % total;
                    drawFrame(currentFrame);
                    lastFrameTime = time;
                }
                
                animationId = requestAnimationFrame(loop);
            };
            
            animationId = requestAnimationFrame(loop);
        }

        function stop() {
            isPlaying = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        init();
    </script>
</body>
</html>