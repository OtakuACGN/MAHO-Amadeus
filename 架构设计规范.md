# 系统架构设计规范

主要记录了整一个项目大致的框架和思路，有些细节有差错请以代码为准。

## 后端架构

后端采用组件化设计，通过统一的管理器和标准的输出队列与外部通信。

### 组件体系
-   组件管理器 (Components.py)：
    -   提供统一的接口对外暴露功能，屏蔽底层具体实现的差异（如不同的 LLM、TTS 模型）。
    -   允许每个组件配置自己的具体实现方法。
    -   还包括了配置的存储，虽然理论上这个功能应该分开单独做，配置文件。有一个backend下的是默认配置文件，但是如果data目录下还有一个配置文件，那么会优先读取data目录下的配置文件。

-   LLM (LLMService.py)：
    -   职责：处理自然语言生成任务。

-   TTS (TTSService.py)：
    -   职责：将文本转换为音频。
    -   锁机制：采用队列锁控制并发访问。锁实现位于 `core/util/resource_lock.py` 的 `ResourceLock` 类。每个角色可提前申请队列，只有队列头部角色才能执行合成，可以通过配置文件决定是否启用此功能。

-   翻译 (TranslatorService.py)：
    -   职责：处理文本翻译任务。

-   ASR (ASRService.py)：
    -   职责：将语音转换为文本。

### 角色系统
-   角色组件 (Character.py)：
    -   具体流程：触发 Chat 函数 → 调用 LLM → LLM 回复分片放入队列 → 队列内容按标点分割供 TTS 处理 → TTS 生成音频 → 经 base64 编码后放入输出队列。
    -   Chat 接口：核心交互入口。
        -   输入：用户或剧本的指令或对话。
        -   行为：调用 Chat 函数，角色自动申请资源（LLM、TTS、翻译等组件），生成数据分片并放入队列。
        -   输出：将生成的回复推送到 `output_queue` 队列。

### 导演与剧本
-   导演 (Director.py)：
    -   系统总控与桥梁：连接用户与角色的核心枢纽。
    -   职责：
        -   决定当前由哪些角色进行回话（调度逻辑）。
        -   作为一个中间件处理各类转发工作。
        -未来扩展：可能承担特殊的游戏化逻辑 or 系统级干预。
-   剧本 (Script.py)：
    -   职责：
        -   记录上下文关系 (Context)。
        -   维护台词表 (Lines)。
        -   未来扩展：作为世界观记录载体，存储设定集与背景信息。

### 输出数据流
后端的输出不是一次性的，而是基于流式传输 (Streaming) 的数据包流。
-   数据结构：
    -   Start Packet：流开始的数据包（包含 meta 信息）。
    -   Content Packets：中间内容包（Type 区分：文本、思考内容、音频分片、扩展类型等）。
    -   End Packet：流结束的标记包。
-   抽象定义：整个回复过程被抽象为一个完整的数据流包组。




## 前端架构
前端严格遵循 MVVM 模式，强调 Store 作为唯一真实数据源。

### 核心通信桥梁
-   演出队列 (performance.ts)：
    -   前端与后端通信的唯一业务桥梁，只存储数据，不包含任何 UI 逻辑。
    -   结构：一个列表，里面的每一个对象都是一次演出，对象长这样：
        -   {
                character: 'maho',
                thinkText: '',
                displayedText: '',
                audioChunks: [],
                isThinkingComplete: false,
                isTextComplete: false,
                isAudioComplete: false,
            }
    -   消费机制：前端时刻监控队列头部对象，进行实时演出（渲染/播放）。播放完毕后移出队列，消费下一个。

### 渲染组件
每个 Store 对应一个具体的渲染组件，尽量不要在这个组件引用其他的store导致互相深度耦合逻辑。

-   Dialog Store (dialog.ts)：
    -   canInput：是否允许输入
    -   showCaret：是否显示输入光标
    -   showDialog：对话框显示状态
    -   currentName：当前角色名称
    -   thinkText：思考内容文本
    -   displayedText：当前显示的对话文本

-   Stage Store (stage.ts)：
    -   主要负责一整个背景还有人物的立绘显示。

-   Audio Store (audio.ts)：
    -   状态：音频播放队列、当前通过 WebSocket 接收到的音频片段。
    -   未来职责：提供口型同步 (Lip-sync) 所需的数据 (如 `mouthOpen` 等)。

-   VAD Store (vad.ts)：
    -   职责：管理录音、VAD 检测状态、音频分片发送。




## 语音交互回路
前端通过语音活动检测（VAD）判断何时将录音片段发送到后端。后端负责将收到的音频转为文本，随后按既定流程处理。目前该语音交互流程尚在完善中。




## 接口协议示例 (Protocol)

后端 -> 前端 WebSocket 消息流示例：

```json
// 1. 开始信号
{ "type": "start", "character": "maho", "requestId": "uuid..." }

// 2. 思考内容 (Stream)
{ "type": "thinkText", "character": "maho", "data": "嗯..." }

// 3. 文本内容 (Stream)
{ "type": "text", "character": "maho", "data": "嗯..." }
{ "type": "text", "character": "maho", "data": "也是命运石之门的选择吗？" }

// 4. 音频内容 (Stream)
{ "type": "audio", "character": "maho", "data": "base64...", "is_final": false }
{ "type": "audio", "character": "maho", "data": "base64...", "is_final": true }

// 5. 结束信号
{ "type": "end", "character": "maho" }
```
