# 角色配置指南

本文档说明如何为 MAHO-Amadeus 添加自定义角色。配置采用**组件 + 角色分离**的设计，你可以复用相同的 TTS/LLM 组件，只切换角色的人设和语音。

---

## 配置文件结构

`backend/config.yaml` 包含两部分：

```yaml
# 1. 组件配置（全局通用）
components:
  llm: { ... }        # LLM 服务配置
  tts: { ... }        # TTS 服务配置  
  translator: { ... } # 翻译服务配置
  asr: { ... }        # 语音识别配置

# 2. 角色配置（每个角色独立）
characters:
  - name: "角色英文名"
    system_prompt: |
      你是 xxx...
      【性格特征】...
      【说话习惯】...
    tts_config:
      character_name: "TTS注册名"
      onnx_model_dir: "模型目录路径"
      reference_audio_path: "参考音频路径"
      reference_audio_text: "参考音频对应的文本"
```

---

## 添加新角色的步骤

### 1. 准备资源文件

| 资源 | 说明 | 存放路径示例 |
|------|------|-------------|
| TTS 模型 | GenieTTS ONNX 模型 | `backend/models/TTS-xxx/` |
| 参考音频 | 角色音色样本（wav格式） | `backend/data/TTS-xxx-ref/xxx.wav` |

GenieTTS 依赖文件下载：
- [GenieData 依赖](https://www.modelscope.cn/models/bysq2006/maho-tts2/resolve/master/GenieData.zip)
- 解压到 `backend/models/GenieData/`

### 2. 修改 config.yaml

在 `characters:` 列表下添加新角色：

```yaml
characters:
  # 已有的角色...
  
  - name: "your_char"
    system_prompt: |
      你是 xxx...
      【性格特征】
      - xxx
      - xxx
      
      【说话习惯】
      - xxx
      
      【行为准则】
      - xxx
      
      请严格保持这个人设，用 xxx 的语气回应。
      回答字数不要太多，要看起来就像视觉小说游戏里面角色的一句对话那样。
      
    tts_config:
      character_name: "your_char"      # TTS 内部注册名，随意
      onnx_model_dir: "backend/models/TTS-your-char"  # 模型目录
      reference_audio_path: "backend/data/TTS-your-char-ref/sample.wav"
      reference_audio_text: "参考音频对应的日文文本"
```

### 3. 关键字段说明

#### system_prompt
- **作用**: 发送给 LLM 的系统提示词，定义角色人设
- **建议**: 包含性格、口癖、说话习惯、行为准则等
- **注意**: 提醒 LLM 回答要简短，像游戏对话框一样

#### tts_config
| 字段 | 必填 | 说明 |
|------|------|------|
| `character_name` | 是 | TTS 服务内部注册名，可随意取 |
| `onnx_model_dir` | 是 | GenieTTS 模型文件夹路径 |
| `reference_audio_path` | 是 | 参考音频文件路径（决定音色） |
| `reference_audio_text` | 是 | 参考音频对应的文本 |

### 4. 重启后端

```bash
cd backend
python main.py
```

---

## 完整示例

```yaml
components:
  llm:
    select: openai_api
    openai_api:
      api_key: "your-key"
      base_url: "https://dashscope.aliyuncs.com/compatible-mode/v1"
      model: "qwen-plus"
      
  tts:
    select: genie_tts_service
    use_resource_lock: true
    genie_tts_service:
      genie_data_dir: "backend/models/GenieData"
      language: "ja"
      auto_load: true
      # 注意：onnx_model_dir 移到 characters 下的 tts_config 中

characters:
  - name: "maho"
    system_prompt: |
      你是比屋定真帆...
    tts_config:
      character_name: "maho"
      onnx_model_dir: "backend/models/TTS-maho"
      reference_audio_path: "backend/data/TTS-audio/平常.wav"
      reference_audio_text: "私の名前、ひやじょうまほ。"

  - name: "your_new_char"
    system_prompt: |
      你是 xxx...
    tts_config:
      character_name: "your_new_char"
      onnx_model_dir: "backend/models/TTS-your-char"
      reference_audio_path: "backend/data/TTS-your-char-ref/ref.wav"
      reference_audio_text: "こんにちは"
```

---

## 常见问题

**Q: 多个角色可以共用同一个 TTS 模型吗？**  
A: 可以，把 `onnx_model_dir` 设成相同路径，但建议不同角色用不同 `reference_audio_path` 来区分音色。

**Q: 切换角色需要重启吗？**  
A: 需要重启后端服务。配置热重载暂时不支持。

**Q: 角色名字可以中文吗？**  
A: `name` 字段建议用英文/拼音（如 `maho`、`mayuri`），这是内部标识。显示名称可以在前端自定义。

**Q: TTS 报错找不到模型？**  
A: 检查 `onnx_model_dir` 路径是否正确，注意相对路径是从项目根目录开始的（如 `backend/models/xxx`）。
